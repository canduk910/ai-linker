<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI-Linker 챗봇</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f6f9;
            display: flex;
            flex-direction: column;
        }
        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            max-height: 100vh;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 0 15px;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 90vh;
            overflow: hidden;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #3B82F6;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        .system-message {
            background-color: #1E40AF;
            color: white;
            align-self: flex-start;
        }
        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #e5e7eb;
        }
        .chat-input-wrapper {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .chat-input-wrapper input {
            flex-grow: 1;
            margin-right: 10px;
        }
        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            .chat-input-wrapper {
                flex-direction: column;
            }
            .chat-input-wrapper input {
                margin-right: 0;
                margin-bottom: 10px;
                width: 100%;
            }
            .chat-input-wrapper button {
                width: 100%;
            }
        }
    </style>
    <script type="module" src="/js/chat-interceptor.js"></script>
</head>
<body>
    <div class="container">
        <div class="chat-container">
            <div class="bg-blue-800 text-white p-4 rounded-t-lg">
                <h2 class="text-xl font-bold">AI-Linker 챗봇</h2>
            </div>
            
            <div id="chat-messages" class="chat-messages">
                <div class="message system-message">
                    안녕하세요! AI-Linker입니다. 소상공인 대출 상담을 도와드리겠습니다.
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input 
                        type="text" 
                        id="message-input" 
                        placeholder="메시지를 입력하세요" 
                        class="input input-bordered"
                    >
                    <button onclick="sendMessage()" class="btn btn-primary">전송</button>
                </div>
            </div>
            
            <div class="p-4 text-center">
                <a href="index.html" class="btn btn-sm">메인으로 돌아가기</a>
                <a href="/apply.html" target="_blank" rel="noopener" class="btn btn-sm"> 신청서 새 탭 열기 </a>
                <button id="toggle-apply" class="btn btn-sm btn-primary"> 신청서 옆에 열기</button>
    </div>
            </div>
        </div>
    </div>


    
    <!-- ===== 우측 드로어(오버레이) ===== -->
    <div id="apply-drawer-backdrop"
         class="fixed inset-0 bg-black/30 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity z-40"></div>

    <aside id="apply-drawer"
           class="fixed top-0 right-0 h-dvh w-full md:w-[560px] bg-base-100 border-l shadow-2xl
                  translate-x-full transition-transform duration-300 z-50 flex flex-col">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <h3 class="font-semibold text-base">대출 신청서</h3>
        <div class="flex gap-2">
          <a href="/apply.html" target="_blank" rel="noopener" class="btn btn-xs">새 탭</a>
          <button id="close-apply" class="btn btn-xs btn-ghost">닫기</button>
        </div>
      </div>
      <iframe id="apply-iframe"
              class="w-full flex-1"
              src=""
              loading="lazy"
              referrerpolicy="no-referrer"
              sandbox="allow-forms allow-scripts allow-same-origin"></iframe>
    </aside>
    <script>
    // 대화 히스토리: 전역(탭 내 유지) + 로컬스토리지 복원
    const CC_KEY = "aiLinker.chat.ctx.v1";
    window.conversationContext = (() => {
      try { return JSON.parse(localStorage.getItem(CC_KEY) || "[]"); } catch { return []; }
    })();
    function saveCtx(){ try { localStorage.setItem(CC_KEY, JSON.stringify(window.conversationContext)); } catch {} }

        function autoScroll() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const messagesContainer = document.getElementById('chat-messages');
            
            if (!input.value.trim()) return;

            // 사용자 메시지 추가
            const userMessage = document.createElement('div');
            userMessage.classList.add('message', 'user-message');
            userMessage.textContent = input.value;
            messagesContainer.appendChild(userMessage);
            autoScroll();

            input_text = input.value;
            
            // 입력창 초기화
            input.value = '';

            // ✅ 인디케이터: 250ms 후에 뜨도록 예약
            AI_LINKER_TYPING.defer(250);

            // 🚨 수정된 부분 시작
            try {
                // 요청 URL을 우리 서버리스 함수 주소('/api/chat')로 변경
                const response = await fetch('/api/chat', { // <-- URL 변경
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                        // 🚨 'Authorization' 헤더를 완전히 제거!
                    },
                    // OpenAI에 보낼 전체 요청 본문을 body에 담아 전송
                    body: JSON.stringify({
                        // model: "ft:gpt-4.1-2025-04-14:koscom:finance:Bx9vf0hL",
                        //model: "gpt-5-mini",
                        //model: "gpt-3.5-turbo",
                        //model: "gpt-5",
                        model: "gpt-4.1",
                        messages: [
                            {
                                role: "system", 
                                content: `당신은 AI-Linker 챗봇입니다. 다음 규칙을 엄격히 따르세요:
                                1. "대출", "소상공인", "정책자금" 중 하나라도 언급되면 "AI-Linker는 소상공인 정책자금 대출의 자동신청을 지원합니다. 어떤 유형의 대출신청을 원하시나요?"라고 안내하고 세션을 유지합니다.
                                2. "신청현황"이 언급되면 "대출 신청 현황을 확인을 위해 신청현황 페이지로 이동하겠습니다."라고 안내합니다.
                                3. "대출신청서"가 언급되면 "신청서 작성을 위해 대출신청서 페이지로 이동하겠습니다."라고 안내합니다.
                                4. 소상공인 대출과 무관한 대화 시도 시 "AI-Linker에서는 현재 소상공인 대출만 지원하고 있습니다."라는 메시지를 출력하고 세션을 종료합니다.
                                5. 대출 관련 정보는 공식 웹사이트의 최신 정보를 기반으로 안내합니다.
                                6. 웹사이트 주소는 답변에 절대 노출하지 마세요.
                                7. 전문적이고 친절한 톤을 유지하세요.`
                            },
                            ...window.conversationContext,
                            {role: "user", content: input_text}
                        ]
                    })
                });
                // 🚨 수정된 부분 끝

                const data = await response.json();
                const aiResponse =
                  (data?.choices?.[0]?.message?.content)
                  ?? (data?.output_text)  // Responses API 형태 대응
                  ?? "";

                // AI 메시지 추가
                const systemMessage = document.createElement('div');
                systemMessage.classList.add('message', 'system-message');
                systemMessage.textContent = aiResponse;
                messagesContainer.appendChild(systemMessage);
                autoScroll();

                // 대화 컨텍스트 업데이트
                window.conversationContext.push(
                    {role: "user", content: input_text},
                    {role: "assistant", content: aiResponse}
                );

                // 길이 제한(최근 10개 메시지 = 5쌍) — 배열 교체 대신 in-place로 잘라서 참조 유지
                const MAX = 10; // 필요시 20(=10쌍)로 늘리세요
                if (window.conversationContext.length > MAX) {
                  window.conversationContext.splice(0, window.conversationContext.length - MAX);
                }
                saveCtx();

                // 신청현황 페이지로 이동 로직
                if (aiResponse.includes('신청현황 페이지로 이동')) {
                    setTimeout(() => {
                        window.location.href = 'status.html';
                    }, 1500);
                }

                // 대출신청서 페이지로 이동 로직
                if (aiResponse.includes('대출신청서 페이지로 이동')) {
                    setTimeout(() => {
                        openApplyPanel();
                    }, 1500);
                }

            } catch (error) {
                console.error('API 호출 중 오류:', error);
                const errorMessage = document.createElement('div');
                errorMessage.classList.add('message', 'system-message');
                errorMessage.textContent = '현재 서비스에 문제가 있습니다. 잠시 후 다시 시도해주세요.';
                messagesContainer.appendChild(errorMessage);
                autoScroll();
            }finally {
                // ✅ 응답 완료 → 인디케이터 닫기
                AI_LINKER_TYPING.done();
              }
        }

        // Enter 키로 메시지 전송
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 초기 스크롤
        autoScroll();
    </script>
    
    <template id="tpl-typing">
      <div class="chat chat-start" data-typing="1">
        <div class="chat-bubble bg-base-200 text-base-content flex items-center gap-2">
          <span class="loading loading-dots loading-sm"></span>
          <span> AI-Linker가 답을 찾는 중… </span>
        </div>
      </div>
    </template>
    
    <!-- ===== 드로어 토글 스크립트 (통일된 openApplyPanel) ===== -->
    <script>
      // 통일 로더: URL 로드 → 타임아웃/에러 시 srcdoc 주입 → 최후엔 새 탭
      window.openApplyPanel = function () {
        const drawer   = document.getElementById("apply-drawer");
        const backdrop = document.getElementById("apply-drawer-backdrop");
        const iframe   = document.getElementById("apply-iframe");

        // 절대 경로 생성 (서브폴더/상대경로 이슈 방지)
        const url = new URL("apply.html", location.origin);
        url.search = "embed=1";
        url.hash   = "autofill=auto";

        let done = false;
        const timeout = setTimeout(() => { if (!done) fallbackToSrcdoc(); }, 2000);
        iframe.onload  = () => { done = true; clearTimeout(timeout); };
        iframe.onerror = () => { done = true; clearTimeout(timeout); fallbackToSrcdoc(); };
        iframe.src = url.toString();

        drawer.classList.remove("translate-x-full");
        backdrop.classList.remove("pointer-events-none");
        backdrop.classList.add("opacity-100");

        async function fallbackToSrcdoc() {
          try {
            const res = await fetch(new URL("apply.html", location.origin), { credentials: "same-origin" });
            if (!res.ok) throw new Error("fetch " + res.status);
            let html = await res.text();
            // 현재 페이지 디렉토리를 base로 설정해 srcdoc의 상대경로를 살림
            const baseHref = new URL(".", location.href).toString();
            html = html.replace(/<head([^>]*)>/i, `<head$1><base href="${baseHref}">`);
            // 임베드/자동채움 보정 스크립트 주입
            html = html.replace(/<\/body>\s*<\/html>\s*$/i,
              `<script>
                 document.addEventListener('DOMContentLoaded', function(){
                   document.querySelector('.navbar')?.classList.add('hidden'); // 임베드 시 헤더 숨김(있다면)
                   setTimeout(()=>document.getElementById('autofill-accept')?.click(), 400);
                 });
               <\/script></body></html>`);
            // 필요 시 sandbox 완화 테스트: iframe.removeAttribute('sandbox');
            iframe.srcdoc = html;
          } catch (e) {
            window.open("/apply.html", "_blank", "noopener"); // 최후 폴백
          }
        }
      };

      (function(){
        const drawer   = document.getElementById("apply-drawer");
        const backdrop = document.getElementById("apply-drawer-backdrop");
        const openBtn  = document.getElementById("toggle-apply");
        const closeBtn = document.getElementById("close-apply");
        function closeDrawer(){
          drawer.classList.add("translate-x-full");
          backdrop.classList.add("pointer-events-none");
          backdrop.classList.remove("opacity-100");
        }
        openBtn?.addEventListener("click", openApplyPanel); // ← 통일된 함수 사용
        closeBtn?.addEventListener("click", closeDrawer);
        backdrop?.addEventListener("click", closeDrawer);
        window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeDrawer(); });
      })();
    </script>
    <!-- ===== 신청서 핸드셰이크 리스너: iframe이 준비되면 엔터티를 즉시 전송 ===== -->
    <script>
      (function () {
        window.addEventListener("message", (e) => {
          // 동일 오리진만 허용(보안)
          if (e.origin !== location.origin) return;
          const msg = e.data || {};
          if (msg.type === "AI_LINKER_APPLY_READY") {
            try {
              const raw = localStorage.getItem("aiLinker.pendingEntities.v1");
              const payload = raw ? JSON.parse(raw).data : null;
              if (payload) {
                // 자식(신청서 iframe)으로 엔터티 즉시 전달
                e.source.postMessage({ type: "AI_LINKER_ENTITIES", payload }, e.origin);
              }
            } catch {}
          }
        });
      })();
    </script>

    
    <script>
    // === 채팅 리스트 컨테이너 추적 ===
    const CHAT_LIST = document.getElementById('chat-messages')
      || document.getElementById('chat-list')
      || document.querySelector('[data-chat-list]')
      || document.querySelector('.chat-list')
      || document.body;
    
    // === 인디케이터 유틸 ===
    (function(global){
      let node = null, timer = null, inflight = 0;
    
      function ensureTemplate() {
        const tpl = document.getElementById('tpl-typing');
        if (!tpl) {
          console.warn('[typing] #tpl-typing not found');
          return null;
        }
        return tpl;
      }
    
      function showNow() {
        if (node) return;
        const tpl = ensureTemplate(); if (!tpl) return;
        node = tpl.content.firstElementChild.cloneNode(true);
        CHAT_LIST.appendChild(node);
        node.scrollIntoView({ behavior: 'smooth', block: 'end' });
      }
    
      function hideNow() {
        clearTimeout(timer);
        if (node) { node.remove(); node = null; }
      }
    
      global.AI_LINKER_TYPING = {
        // 250ms 이상 걸릴 때만 표시(깜빡임 방지)
        defer(delay = 250){ clearTimeout(timer); timer = setTimeout(showNow, delay); inflight++; },
        done(){ inflight = Math.max(0, inflight - 1); if (inflight === 0) hideNow(); },
        forceShow(){ showNow(); },
        forceHide(){ inflight = 0; hideNow(); }
      };
    })(window);
    </script>
    
</body>
</html>
